{% extends 'moodiecinema/base.html' %}
{% load static %}

{% block title %}ì¼ê¸°ì¥{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'diary.css' %}">
{% endblock %}

{% block content %}
<div class="diary-container">
    <!-- ì²« ë²ˆì§¸ ëª¨ë‹¬ì°½: ì¼ê¸° ì‘ì„± -->
    <div id="diaryModal" class="modal">
        <div class="modal-content small-modal">
            <h3>ì¼ê¸° ì‘ì„±</h3>
            <p>ì˜¤ëŠ˜ì˜ ê°ì •ì„ ì ì–´ë³´ì„¸ìš”.</p>
            <div class="modal-buttons">
                <button class="btn close-btn" onclick="closeDiaryModal()">ë‹«ê¸°</button>
                <button class="btn write-btn" onclick="openSecondModal()">ë°”ë¡œ ì“°ê¸°</button>
                <button class="btn skip-btn" onclick="skipToday()">ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë‘ ë²ˆì§¸ ëª¨ë‹¬ì°½: ì¼ê¸° ì‘ì„± ì…ë ¥ -->
    <div id="diaryEntryModal" class="modal" style="display: none;">
        <div class="modal-content medium-modal">
            <h3>ì¼ê¸° ì‘ì„±</h3>
            <label for="entryDateInput">ë‚ ì§œ:</label>
            <div class="date-input">
                <input type="date" id="entryDateInput" placeholder="ë…„ë„-ì›”-ì¼">
            </div>
            <label for="entryContent">ë‚´ìš©:</label>
            <textarea id="entryContent" placeholder="ì˜¤ëŠ˜ì˜ ê°ì •ì„ ì ì–´ë³´ì„¸ìš”..." rows="5"></textarea>
            <div class="modal-buttons">
                <button class="btn close-btn" onclick="closeSecondModal()">ë‹«ê¸°</button>
                <button class="btn write-btn" onclick="saveDiaryEntry()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ë‹¬ë ¥ -->
    <div id="calendar" class="calendar">
        <div class="calendar-header">
            <button class="btn arrow-btn" onclick="previousMonth()">&#9664;</button>
            <h2 id="calendarTitle">2024ë…„ 11ì›”</h2>
            <button class="btn arrow-btn" onclick="nextMonth()">&#9654;</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
                </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
        </table>
        <button class="btn reset-skip-btn" id="resetSkipBtn" onclick="resetSkipToday()" style="display: none;">ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸° ì´ˆê¸°í™”</button>
    </div>    
    

    <!-- ì„ íƒëœ ë‚ ì§œì˜ ì¼ê¸° ì„¸ë¶€ í˜ì´ì§€ -->
    <div id="diaryEntry" class="diary-entry" style="display: none;">
        <div class="diary-background"></div> <!-- ë°°ê²½ ì´ë¯¸ì§€ ë ˆì´ì–´ -->
        <div class="diary-content"> <!-- ì‹¤ì œ ë‚´ìš© -->
            <h2 id="entryDate">ì¼ê¸° ë‚ ì§œ
                <button class="btn open-modal-btn" onclick="openDiaryModal()">ì¼ê¸° ì‘ì„±í•˜ê¸°</button>
            </h2>
            
            <div class="entry-content">
                <div class="entry-text">
                    <h3>ì¼ê¸° ë‚´ìš©</h3>
                    <div class="diary-box">
                        <p id="diaryContent">ì—¬ê¸°ì— ì¼ê¸° ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤...</p>
                    </div>
                </div>
            </div>

        <!-- ê°ì • ë¶„ì„ ê²°ê³¼ ë°•ìŠ¤ -->
        <div class="emotion-analysis">
            <h3>ê°ì • ë¶„ì„ ê²°ê³¼</h3>
            <div class="emotion-box">
                <p>ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- ì¶”ì²œ ì˜í™” ë¦¬ìŠ¤íŠ¸ -->
        <div class="recommendations">
            <h3>ì´ ì¼ê¸°ì—” ì´ ì˜í™”ë¥¼ ì¶”ì²œ ë“œë ¤ìš”!</h3>
            <div class="movie-list" id="movieList">
                <!-- ì¶”ì²œ ì˜í™”ê°€ JavaScriptë¡œ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
    function openDiaryModal() {
        document.getElementById("diaryModal").style.display = "flex";
    }
    
    function closeDiaryModal() {
        document.getElementById("diaryModal").style.display = "none";
    }

    function skipToday() {
        const today = new Date();
        const todayDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        localStorage.setItem("skipDiaryModal", todayDateString);
        closeDiaryModal();
    }

    function openSecondModal() {
        closeDiaryModal();
        document.getElementById("diaryEntryModal").style.display = "flex";
    }
    
    function closeSecondModal() {
        document.getElementById("diaryEntryModal").style.display = "none";
    }
    
    function saveDiaryEntry() {
        const date = document.getElementById("entryDateInput").value;
        const content = document.getElementById("entryContent").value;

        if (!date || !content) {
            alert("ë‚ ì§œì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch("{% url 'diary_create' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                date: date,
                content: content,
                emotion: "ê¸ì •"  // ì˜ˆì‹œë¡œ ê³ ì •ëœ ê°’, ì‹¤ì œ ê°ì • ë¶„ì„ ê²°ê³¼ ë°˜ì˜ ê°€ëŠ¥
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                closeSecondModal();
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error("Error saving diary entry:", error);
            alert("ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    const diaryDetailUrl = "{% url 'diary_detail' %}";

    function openDiaryEntry(date) {
    fetch(`${diaryDetailUrl}?date=${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification("í•´ë‹¹ ë‚ ì§œì˜ ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error"); // ì˜¤ë¥˜ ì•Œë¦¼ ë©”ì‹œì§€
            } else {
                const diary = data.diary;
                if (diary) {
                    document.getElementById("entryDate").innerText = `${date} ì¼ê¸°`;
                    document.getElementById("diaryContent").innerText = diary.content || "ì¼ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                    document.querySelector('.emotion-box p').innerText = `ê°ì • ë¶„ì„ ê²°ê³¼: ${diary.emotion || 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}`;

                    // Populate the recommended movie list with links
                    const movieList = document.getElementById("movieList");
                    movieList.innerHTML = ''; // Clear any existing content
                    diary.recommended_movies.forEach(movie => {
                        if (movie.id) { // Ensure each movie has a valid ID
                            const movieItem = document.createElement('div');
                            movieItem.classList.add('movie-item');
                            movieItem.innerHTML = `
                                <a href="/movies/${movie.id}/">
                                    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title}">
                                    <h3>${movie.title}</h3>
                                </a>
                            `;
                            movieList.appendChild(movieItem);
                        }
                    });

                    // Update background based on emotion
                    changeBackgroundByEmotion(diary.emotion);
                }
                document.getElementById("calendar").style.display = "none";
                document.getElementById("diaryEntry").style.display = "block";
            }
        })
        .catch(error => {
            console.error("Error fetching diary entry:", error);
            showNotification("ì¼ê¸°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error"); // ì‹¤íŒ¨ ì•Œë¦¼ ë©”ì‹œì§€
        });
}

function showNotification(message, type = "success") {
    const notification = document.getElementById('notification');
    notification.textContent = message; // ë©”ì‹œì§€ ì„¤ì •
    notification.className = `notification ${type} show`; // ì•Œë¦¼ ìŠ¤íƒ€ì¼ ì ìš©

    // 3ì´ˆ í›„ ì•Œë¦¼ ìë™ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}



    function changeBackgroundByEmotion(emotion) {
    const diaryEntry = document.querySelector('.diary-entry');
    let imageUrl = "";

    switch (emotion) {
        case "ìŠ¬í””":
            imageUrl = "{% static 'images/ìŠ¬í””.jpg' %}";
            break;
        case "ê³µí¬":
            imageUrl = "{% static 'images/ê³µí¬ê°ì •.jpg' %}";
            break;
        case "ë¶„ë…¸":
            imageUrl = "{% static 'images/ë¶„ë…¸.jpg' %}";
            break;
        case "í‰ì˜¨":
            imageUrl = "{% static 'images/í‰ì˜¨.jpg' %}";
            break;
        case "ê¸°ì¨":
            imageUrl = "{% static 'images/ê¸°ì¨.jpg' %}";
            break;
        default:
            imageUrl = "{% static 'images/ê¸°ì¨.jpg' %}";
    }

    // ë°°ê²½ ì´ë¯¸ì§€ë¥¼ diary-entryì—ë§Œ ì ìš©
    diaryEntry.style.backgroundImage = `url('${imageUrl}')`;
    diaryEntry.style.backgroundSize = "cover"; // í™”ë©´ì— ê½‰ ì°¨ê²Œ
    diaryEntry.style.backgroundPosition = "center"; // ì¤‘ì•™ ì •ë ¬
    diaryEntry.style.backgroundAttachment = "fixed"; // ê³ ì • ë°°ê²½
}


    function renderCalendar(year, month) {
        const calendarTitle = document.getElementById("calendarTitle");
        const calendarBody = document.getElementById("calendarBody");
        calendarTitle.innerText = `${year}ë…„ ${monthNames[month]}`;

        calendarBody.innerHTML = "";

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
    // API í˜¸ì¶œ: í•´ë‹¹ ì›”ì˜ ì¼ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/diary/month/?year=${year}&month=${month + 1}`)
        .then(response => response.json())
        .then(data => {
            const diaryData = data.diaries || {};

            let row = document.createElement("tr");
            for (let i = 0; i < firstDay; i++) {
                row.appendChild(document.createElement("td"));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                if (row.children.length === 7) {
                    calendarBody.appendChild(row);
                    row = document.createElement("tr");
                }

                const cell = document.createElement("td");
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                cell.innerText = day;
                cell.onclick = () => openDiaryEntry(dateString);

                // ì¼ê¸° ë°ì´í„°ì— ë‚ ì§œê°€ ìˆëŠ” ê²½ìš° ì´ëª¨í‹°ì½˜ ì¶”ê°€
                if (diaryData[dateString]) {
                    const emotion = diaryData[dateString];
                    const emoji = getEmojiByEmotion(emotion); // ê°ì •ì— ë”°ë¥¸ ì´ëª¨í‹°ì½˜ ê²°ì •
                    const emojiSpan = document.createElement("span");
                    emojiSpan.textContent = emoji;
                    emojiSpan.className = "emoji";
                    cell.appendChild(emojiSpan);
                }

                row.appendChild(cell);
            }

            if (row.children.length > 0) {
                calendarBody.appendChild(row);
            }
        })
        .catch(error => {
            console.error("Error fetching diary data:", error);
        });
}

function getEmojiByEmotion(emotion) {
    const emojiMap = {
        "ê¸°ì¨": "ğŸ˜Š",
        "ìŠ¬í””": "ğŸ˜¢",
        "ë¶„ë…¸": "ğŸ˜¡",
        "ê³µí¬": "ğŸ˜±",
        "í‰ì˜¨": "ğŸ˜Œ"
    };
    return emojiMap[emotion] || "ğŸ“"; // ê¸°ë³¸ ì´ëª¨í‹°ì½˜
}

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonth);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
    }

    document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const todayDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const skipDiaryModalDate = localStorage.getItem("skipDiaryModal");

        if (skipDiaryModalDate !== todayDateString) {
            openDiaryModal();
        }

        renderCalendar(currentYear, currentMonth);
    });

    const csrftoken = getCookie('csrftoken');
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function resetSkipToday() {
        localStorage.removeItem("skipDiaryModal");
        alert("ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸° ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ëª¨ë‹¬ì´ ë‹¤ì‹œ í‘œì‹œë©ë‹ˆë‹¤.");
    }

    const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message; // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    notification.classList.add('show'); // ë³´ì´ê¸° í´ë˜ìŠ¤ ì¶”ê°€

    // 3ì´ˆ í›„ì— ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// ì‚¬ìš© ì˜ˆì‹œ
function saveDiaryEntry() {
    const date = document.getElementById("entryDateInput").value;
    const content = document.getElementById("entryContent").value;

    if (!date || !content) {
        alert("ë‚ ì§œì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    fetch("{% url 'diary_create' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            date: date,
            content: content,
            emotion: "ê¸ì •"  // ê°ì • ë¶„ì„ ê²°ê³¼
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification("ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"); // ì„±ê³µ ë©”ì‹œì§€
            closeSecondModal(); // ëª¨ë‹¬ ë‹«ê¸°
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error("Error saving diary entry:", error);
        alert("ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });
}

function resetSkipToday() {
        localStorage.removeItem("skipDiaryModal"); // ì„¤ì • ì´ˆê¸°í™”
        showNotification("ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸° ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

function resetSkipToday() {
    localStorage.removeItem("skipDiaryModal"); // ì´ˆê¸°í™”
    showNotification("ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸° ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!"); // ì„±ê³µ ë©”ì‹œì§€
}

// ì˜¤ëŠ˜í•˜ë£¨ ì•ˆë³´ê¸° ë²„íŠ¼ ëˆ„ë¥¼ ì‹œ ì˜¤ëŠ˜í•˜ë£¨ ì•ˆë³´ê¸° ì´ˆê¸°í™”
function skipToday() {
    const today = new Date();
    const todayDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    localStorage.setItem("skipDiaryModal", todayDateString);
    document.getElementById("resetSkipBtn").style.display = "block"; // ë²„íŠ¼ í‘œì‹œ
    closeDiaryModal();
}

function resetSkipToday() {
    localStorage.removeItem("skipDiaryModal"); // ì„¤ì • ì´ˆê¸°í™”
    document.getElementById("resetSkipBtn").style.display = "none"; // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    showNotification("ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸° ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!"); // ì„±ê³µ ë©”ì‹œì§€
}

</script>
{% endblock %}
