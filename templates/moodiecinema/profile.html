{% extends 'moodiecinema/base.html' %}
{% load static %}

{% block title %}프로필{% endblock %}

{% block head %}
  <!-- CSS와 Chart.js 라이브러리 추가 -->
  <link rel="stylesheet" href="{% static 'profile.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot/build/Chart.BoxPlot.js"></script>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- 프로필 헤더 -->
    <div class="profile-header">
        <div class="profile-avatar">
            {% if user.user_profile %}
            <!-- 사용자가 업로드한 프로필 사진 -->
                <img src="{{ user.user_profile.url }}" alt="프로필 사진">
            {% else %}
            <!-- 프로필 사진이 없는 경우 사용자 이름의 첫 글자로 표시 -->
                <div class="avatar-initial">{{ user.user_name|slice:":1" }}</div>
            {% endif %}
        </div>
        <div class="profile-info">
            <!-- 사용자 이름과 가입 날짜 표시 -->
            <h2 class="username">{{ user.user_name }}</h2>
            <p class="membership-date">{{ user.date_joined|date:"Y년 n월 d일"}}부터 회원</p>
        </div>
        <div class="profile-stats">
             <!-- 평균 영화 점수와 TV 점수 -->
            <div class="stat-item">
                <p class="stat-value">0</p>
                <span>평균 영화 점수</span>
            </div>
            <div class="stat-item">
                <p class="stat-value">0</p>
                <span>평균 TV 점수</span>
            </div>
        </div>
    </div>

    <!-- 탭 네비게이션 -->
    <div class="profile-tabs">
        <!-- 각 버튼 클릭 시 특정 섹션 표시 -->
        <button class="tab" onclick="showSection('authorStatisticsSection')">나의 기록</button>
        <button class="tab" onclick="showSection('deleteAccountSection')">회원 탈퇴</button>
    </div>

    <!-- 작성자 통계 섹션 -->
    <div id="authorStatisticsSection" class="profile" style="display: none;">
        <table>
            <h1>{{ user.user_name }}님의 기록</h1>

            <!-- 리뷰 작성 수 -->
            <div class="card">
                <h2>나의 리뷰 작성 수</h2>
                <p class="stat">{{ review_count }}건</p>
            </div>

            <!-- 리뷰 평균 평점 -->
            <div class="card">
                <h2>나의 리뷰 평균 평점</h2>
                <p class="stat">{{ average_rating|default:"평점 없음" }} / 5.0 ⭐⭐⭐⭐⭐</p>
            </div>

            <!-- 가장 높게 평가한 영화 -->
            <div class="card">
                <h2>가장 높게 평가한 영화</h2>
                {% if highest_rating_review %}
                    <p>{{ highest_rating_review.movie.title }} ({{ highest_rating_review.rating }}⭐)</p>
                {% else %}
                    <p>없음</p>
                {% endif %}
            </div>

            <!-- 가장 낮게 평가한 영화 -->
            <div class="card">
                <h2>가장 낮게 평가한 영화</h2>
                {% if lowest_rating_review %}
                    <p>{{ lowest_rating_review.movie.title }} ({{ lowest_rating_review.rating }}⭐)</p>
                {% else %}
                    <p>없음</p>
                {% endif %}
            </div>

            <!-- 감정 분석 결과 -->
            <div class="card">
                <h2>나의 리뷰 감정 분석</h2>
                <canvas id="emotionDoughnutChart"></canvas>
            </div>
        </table>
    </div>
    <script>
        const emotionPercentage = {{ emotion_percentage|safe }};
        const labels = Object.keys(emotionPercentage);
        const data = Object.values(emotionPercentage);
    
        const ctxDoughnut = document.getElementById('emotionDoughnutChart')?.getContext('2d');
        if (ctxDoughnut) {
            const doughnutData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#f9d342', // 기쁨
                        '#4a90e2', // 슬픔
                        '#50c878', // 평온
                        '#e74c3c', // 분노
                        '#8e44ad', // 공포
                    ],
                    hoverOffset: 4
                }]
            };
    
            new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: doughnutData,
                options: {
                    responsive: false, // 부모 요소에 맞추지 않음
                    maintainAspectRatio: false, // 비율 유지 해제
                    
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                    },
                },
            });
        } else {
            console.error("Canvas context를 찾을 수 없습니다.");
        }
    </script>
    


    <!-- 회원 탈퇴 섹션 -->
    <div id="deleteAccountSection" class="profile-section" style="display: none;">
        <h3>회원 탈퇴</h3>
        <p class="warning-text">회원님께선 <strong>위험 구역</strong>에 진입하셨습니다! 정말로 계정 삭제를 원하신다면, 하단에 비밀번호를 입력해주세요.</p>
        <input type="password" id="password" placeholder="계속하려면 현재 비밀번호를 입력하십시오...">
        <button class="btn continue-btn" onclick="showConfirmModal()">계속</button>
    </div>

    <!-- 회원 탈퇴 확인 모달 -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>회원 탈퇴 확인</h3>
            <p>정말로 회원 탈퇴를 진행하시겠습니까?</p>
            <div class="btn-container">
                <form id="deleteAccountForm" action="{% url 'delete_account' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="password" id="confirmPasswordInput">
                    <button type="submit" class="btn confirm-btn">예</button>
                </form>
                <button class="btn cancel-btn" onclick="closeModal()">아니오</button>
            </div>
        </div>
    </div>

    <!-- 회원 탈퇴 -->
    <div id="deleteAccountSection" class="profile-section" style="display: none;">
        <h3>회원 탈퇴</h3>
        <p class="warning-text">회원님께선 <strong>위험 구역</strong>에 진입하셨습니다! 정말로 계정 삭제를 원하신다면, 하단에 비밀번호를 입력해주세요.</p>
        <input type="password" id="password" placeholder="계속하려면 현재 비밀번호를 입력하십시오...">
        <button class="btn continue-btn" onclick="showConfirmModal()">계속</button>
    </div>
    

    <!-- 회원 탈퇴 확인 모달 -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>회원 탈퇴 확인</h3>
            <p>정말로 회원 탈퇴를 진행하시겠습니까?</p>
            <div class="btn-container">
                <!-- 계정 삭제 확인 폼 -->
                <form id="deleteAccountForm" action="{% url 'delete_account' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="password" id="confirmPasswordInput">
                    <button type="submit" class="btn confirm-btn">예</button>
                </form>
                <button class="btn cancel-btn" onclick="closeModal()">아니오</button>
            </div>
        </div>
    </div>

    <!-- 하단 버튼 -->
    <div class="action-buttons">
        <a href="{% url 'update_profile' %}" class="btn edit-profile-btn">회원정보 수정</a>
        <a href="{% url 'logout' %}" class="btn logout-btn">로그아웃</a>
        <a href="{% url 'home' %}" class="btn home-btn">홈으로 이동</a>
        <a href="{% url 'reviews_manage' %}" class="btn home-btn">리뷰 관리</a>
    </div>
</div>

<script>
    function showSection(sectionId) {
        const sections = document.querySelectorAll('.profile-section');
        sections.forEach(section => {
            section.style.display = 'none'; // 모든 섹션 숨김
        });

        const activeSection = document.getElementById(sectionId);
        if (activeSection) {
            activeSection.style.display = 'block'; // 선택된 섹션만 표시
        }
    }
    function showConfirmModal() {
        const password = document.getElementById("password").value;
        if (password) {
            document.getElementById("confirmPasswordInput").value = password;
            document.getElementById("confirmModal").style.display = "block";
        } else {
            alert("비밀번호를 입력해주세요.");
        }
    }

    // 탈퇴 확인 모달 닫기
    function closeModal() {
        document.getElementById("confirmModal").style.display = "none";
    }
</script>
{% endblock %}
