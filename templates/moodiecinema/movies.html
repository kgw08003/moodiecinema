{% extends 'moodiecinema/base.html' %}
{% load static %}
{% block content %}
{% block head %}
<link rel="stylesheet" href="{% static 'movies.css' %}">
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

<body data-movie-id="{{ movie.id }}">
    <section class="movie-detail-container">
        <div class="movie-header">
            <!-- ì˜í™” í¬ìŠ¤í„° -->
            <div class="movie-poster">
                <img src="{% if movie.poster_path %}https://image.tmdb.org/t/p/w300{{ movie.poster_path }}{% else %}/static/images/No_Poster.png{% endif %}"
                    alt="{{ movie.title }}">
            </div>

            <!-- ì˜í™” ì •ë³´ -->
            <div class="movie-info">
                <h1>{{ movie.title }}</h1>
                <p class="release-date"><strong>ê°œë´‰ì¼:</strong> {{ movie.release_date }}</p>
                <p class="genres"><strong>ì¥ë¥´:</strong>
                    {% for genre in movie.genres %}
                    {{ genre.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <p class="rating"><strong>í‰ì :</strong> {{ movie.vote_average }} / 10</p>
                <p class="rating">
                    <strong> ê°ì • :</strong>
                    <span>{{ total_sentiment_emoji }}</span>
                </p>

                <p class="overview"><strong>ê°œìš”:</strong> {{ movie.overview|default:"ê°œìš” ì—†ìŒ" }}</p>

                <h2>ê°ë…</h2>
                {% if director %}
                <div class="director-item">
                    <a href="{% url 'movies:director_movies' director.id %}">
                        <img src="{% if director.profile_path %}https://image.tmdb.org/t/p/w200{{ director.profile_path }}{% else %}{% static 'images/default-profile.png' %}{% endif %}"
                            alt="{{ director.name }}">
                        <span>{{ director.name }}</span>
                    </a>
                </div>
                {% else %}
                <p>ê°ë… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            <!-- ì°œ ëª©ë¡ì— ì¶”ê°€ ë²„íŠ¼ -->
            <div class="action-buttons">
                <div class="wishlist-container">
                    <button class="wishlist-button add-to-wishlist" onclick="addToWishlist({{ movie.id }})">
                        <i class="fas fa-heart"></i> ì°œ ì¶”ê°€
                    </button>
                    <button class="wishlist-button remove-from-wishlist" onclick="removeFromWishlist({{ movie.id }})">
                        <i class="fas fa-times"></i> ì°œ ì‚­ì œ
                    </button>
                </div>
                <!-- ì•Œë¦¼ íŒì—… -->
                <div id="notification" class="notification"></div>
            </div>
        </div>
    </section>

    <!-- ì¶œì—°ì§„ ìŠ¬ë¼ì´ë” -->
    <section class="cast-list-container">
        <h2>ì¶œì—°ì§„</h2>
        <div class="cast-slider-container">
            <button class="scroll-button left" onclick="scrollCast('left')">&#8249;</button>
            <div class="cast-slider" id="cast-slider">
                {% for actor in cast %}
                <div class="cast-item">
                    <a href="{% url 'movies:actor_movies' actor.id %}">
                        <img src="{% if actor.profile_image_url %}{{ actor.profile_image_url }}{% else %}{% static 'images/no-image.png' %}{% endif %}"
                            alt="{{ actor.name }}">
                        <span>{{ actor.name }}</span><br>
                        <em>ì—­í• :</em> {{ actor.character }}
                    </a>
                </div>
                {% endfor %}
            </div>
            <button class="scroll-button right" onclick="scrollCast('right')">&#8250;</button>
        </div>
    </section>

    <!-- ì˜ˆê³ í¸ -->
    <section class="youtube-videos-container">
        <div class="additional-info">
            <h2>ì˜ˆê³ í¸</h2>
            {% if youtube_trailers %}
            {% for video in youtube_trailers %}
            <iframe width="560" height="315" src="https://www.youtube.com/embed/{{ video.key }}" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen onerror="handleVideoError(this)">
            </iframe>
            {% endfor %}
            {% else %}
            <h3 style="color:white; margin:20px;">ì˜ˆê³ í¸ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
            {% endif %}
        </div>
            <h2>ì˜ˆë§¤ì‚¬ì´íŠ¸ë¡œ ì´ë™</h2>
            <div class="ticket">
                <a href="https://www.cgv.co.kr/">
                    <img src="{% static 'images/CGV_logo.png' %}" alt="CGV"  class="cgv_logo">
                </a>
                <a href="https://www.megabox.co.kr/">
                    <img src="{% static 'images/Megabox_logo.png' %}" alt="Megabox">
                </a>
                <a href="https://www.lottecinema.co.kr/NLCHS">
                    <img src="{% static 'images/LotteCineMa_logo1.png'%}" alt="Lotte Cinema">
                </a>
            </div>
    </section>

    <!-- ìœ ì‚¬í•œ ì˜í™” ìŠ¬ë¼ì´ë” -->
    <section class="similar-movies-container">
        <h2>ìœ ì‚¬í•œ ì˜í™”</h2>
        <div class="slider-wrapper">
            <button class="scroll-button left" onclick="slideMovies('left')"><</button>
                    <div class="slider-container" id="similar-slider">
                        {% for similar_movie in similar_movies %}
                        <div class="slider-item">
                            <a href="{% url 'movies:movie_detail' similar_movie.id %}">
                                <img src="https://image.tmdb.org/t/p/w300{{ similar_movie.poster_path }}"
                                    alt="{{ similar_movie.title }}">
                                <p>{{ similar_movie.title }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="scroll-button right" onclick="slideMovies('right')">></button>
        </div>
    </section>

    <script>
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message; // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸

            // íƒ€ì…ì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€
            if (type === 'success') {
                notification.classList.remove('error'); // ê¸°ì¡´ ì—ëŸ¬ í´ë˜ìŠ¤ ì œê±°
                notification.classList.add('success'); // ì„±ê³µ í´ë˜ìŠ¤ ì¶”ê°€
            } else if (type === 'error') {
                notification.classList.remove('success'); // ê¸°ì¡´ ì„±ê³µ í´ë˜ìŠ¤ ì œê±°
                notification.classList.add('error'); // ì—ëŸ¬ í´ë˜ìŠ¤ ì¶”ê°€
            }

            notification.classList.add('show'); // ì•Œë¦¼ í‘œì‹œ

            // 3ì´ˆ í›„ì— ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function addToWishlist(movieId) {
            fetch(`/wishlist/add-to-wishlist/${movieId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    showNotification('ì˜í™”ê°€ ì°œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                })
                .catch(error => console.error('Error:', error));
        }

        function removeFromWishlist(movieId) {
            fetch(`/wishlist/remove-from-wishlist/${movieId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    showNotification('ì˜í™”ê°€ ì°œ ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error'); // ì‚­ì œ ì‹œ ì—ëŸ¬ ìŠ¤íƒ€ì¼
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
    <script src="https://kit.fontawesome.com/23cecef777.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentIndex = 0;
        const itemWidth = 320; // ì•„ì´í…œì˜ ë„ˆë¹„ (ìŠ¬ë¼ì´ë“œ í•œ ë²ˆì— ì´ë™í•  ê±°ë¦¬)
        const itemWidth2 = 160;
        const slider = document.getElementById('similar-slider');
        const castList = document.getElementById('cast-slider');
        const items = slider.children;
        const castItems = castList.children;

        // ìœ ì‚¬ ì˜í™” ìŠ¬ë¼ì´ë” ì™¼ìª½ìœ¼ë¡œ ì´ë™
        function slideMovies(direction) {
            const list = document.getElementById('similar-slider');
            const totalItems = items.length;
            if (direction === 'left') {
                list.scrollLeft -= itemWidth;
            } else if (direction === 'right') {
                list.scrollLeft += itemWidth;
            }
        }

        // ì¶œì—°ì§„ ìŠ¬ë¼ì´ë” ì™¼ìª½ìœ¼ë¡œ ì´ë™
        function scrollCast(direction) {
            const list = document.getElementById('cast-slider');
            const totalItems = castItems.length;
            if (direction === 'left') {
                list.scrollLeft -= itemWidth2;
            } else if (direction === 'right') {
                list.scrollLeft += itemWidth2;
            }
        }

        function handleVideoError(iframe) {
            // ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì˜ˆê³ í¸ì´ ì—†ë‹¤ëŠ” ë©”ì‹œì§€ë¥¼ í‘œì‹œ
            const trailerSection = iframe.closest('.additional-info');
            const noTrailerMessage = trailerSection.querySelector('h3');
            noTrailerMessage.textContent = 'ì˜ˆê³ í¸ì´ ì—†ìŠµë‹ˆë‹¤.';
            noTrailerMessage.style.color = 'white';
            noTrailerMessage.style.margin = '20px';
        }
    </script>
    <script>
        function likeReview(reviewId) {
            fetch(`/reviews/review/${reviewId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`like-count-${reviewId}`).innerText = data.like_count;
                })
                .catch(error => console.error('Error:', error));
        }

        function dislikeReview(reviewId) {
            fetch(`/reviews/review/${reviewId}/dislike/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`dislike-count-${reviewId}`).innerText = data.dislike_count;
                })
                .catch(error => console.error('Error:', error));
        }
    </script>

    <!-- ë¦¬ë·° ì„¹ì…˜ ì¶”ê°€ -->
    <section class="reviews-section">
        <h2 class="reviews-title" style="display: inline-block;">ë¦¬ë·°</h2>
        <a href="{% url 'movies:review_stats' movie_id=movie.id %}" class="review-stats-button">ë¦¬ë·° í†µê³„</a>

        <!-- ë¦¬ë·° ì‘ì„± í¼ -->
        <form method="post" action="{% url 'reviews:review_create' movie_id=movie.id %}" class="review-form">
            {% csrf_token %}
            {{ review_form.as_p }}
            <button type="submit" class="submit-button">ë¦¬ë·° ì‘ì„±</button>
        </form>

        <!-- ì •ë ¬ ì˜µì…˜ê³¼ ë¦¬ë·° ëª©ë¡ -->
        <form method="get" action="{% url 'movies:movie_detail' movie_id=movie.id %}" class="sort-form">
            <label for="sort" class="sort-label">ì •ë ¬ ê¸°ì¤€:</label>
            <select name="sort" id="sort" onchange="this.form.submit()">
                <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                <option value="highest_rating" {% if request.GET.sort == 'highest_rating' %}selected{% endif %}>í‰ì  ë†’ì€ ìˆœ</option>
                <option value="lowest_rating" {% if request.GET.sort == 'lowest_rating' %}selected{% endif %}>í‰ì  ë‚®ì€ ìˆœ</option>
                <option value="most_likes" {% if request.GET.sort == 'most_likes' %}selected{% endif %}>ì¢‹ì•„ìš” ë§ì€ ìˆœ</option>
            </select>
        </form>
        

        <ul class="reviews-list">
            {% for review in reviews %}
            <li class="review-item" data-review-id="{{ review.id }}">
                <div class="review-header">
                    <strong class="review-username">{{ review.user.user_name }}</strong> -
                    <span class="review-date">{{ review.created_at|date:"Y-m-d" }}</span>
                    <span class="review-rating"> | í‰ì : {{ review.rating }} / 5</span>
                    <span class="review-emotion"> | ê°ì •: {{ review.emotion|default:"ë¶„ì„ ê²°ê³¼ ì—†ìŒ" }}</span>
                </div>

                <p class="review-content">{{ review.content }}</p>

                <div class="like-dislike-buttons">
                    <button onclick="likeReview({{ review.id }})" class="like-button">
                        ğŸ‘ <span id="like-count-{{ review.id }}">{{ review.like_count }}</span>
                    </button>
                    <button onclick="dislikeReview({{ review.id }})" class="dislike-button">
                        ğŸ‘ <span id="dislike-count-{{ review.id }}">{{ review.dislike_count }}</span>
                    </button>
                </div>

                <!-- ì‹ ê³  ë²„íŠ¼ -->
                <button onclick="openReportModal({{ review.id }})" class="report-button">ğŸš¨ ì‹ ê³ </button>
            </li>
            {% empty %}
            <p class="no-reviews-message">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            {% endfor %}
        </ul>


        <!-- ì‹ ê³  ëª¨ë‹¬ ì°½ -->
        <div id="report-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeReportModal()">&times;</span>
                <h2>ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>

                <form id="report-form">
                    {% csrf_token %}
                    <input type="hidden" id="review-id" name="review_id">

                    <label><input type="radio" name="report_reason" value="spam" required> ë„ë°°ì„± ê²Œì‹œë¬¼</label><br>
                    <label><input type="radio" name="report_reason" value="inappropriate"> ë¶€ì ì ˆí•œ ë‚´ìš©</label><br>
                    <label><input type="radio" name="report_reason" value="false_info"> ê±°ì§“ ì •ë³´</label><br>

                    <button type="button" onclick="submitReport()">ì‹ ê³  ì œì¶œ</button>
                </form>
            </div>
        </div>

        <script>
            function getCsrfToken() {
                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            }

            function likeReview(reviewId) {
                fetch(`/reviews/review/${reviewId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),  // getCsrfToken() í•¨ìˆ˜ ì‚¬ìš©
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById(`like-count-${reviewId}`).innerText = data.like_count;
                    })
                    .catch(error => console.error('Error:', error));
            }

            function dislikeReview(reviewId) {
                fetch(`/reviews/review/${reviewId}/dislike/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),  // getCsrfToken() í•¨ìˆ˜ ì‚¬ìš©
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById(`dislike-count-${reviewId}`).innerText = data.dislike_count;
                    })
                    .catch(error => console.error('Error:', error));
            }

            function openReportModal(reviewId) {
                console.log("openReportModal í˜¸ì¶œë¨, reviewId:", reviewId); // ë””ë²„ê¹…ìš© ë¡œê·¸
                const modal = document.getElementById('report-modal');
                if (modal) {
                    modal.style.display = 'flex'; // ëª¨ë‹¬ ì—´ê¸°
                    modal.style.visibility = 'visible'; // ëª¨ë‹¬ í‘œì‹œ
                    modal.style.opacity = '1'; // ì™„ì „í•˜ê²Œ ë³´ì´ê²Œ ì„¤ì •
                } else {
                    console.error("ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                // ë¦¬ë·° IDë¥¼ ìˆ¨ê²¨ì§„ í•„ë“œì— ì„¤ì •
                document.getElementById('review-id').value = reviewId;

                // localStorageì— ëª¨ë‹¬ ìƒíƒœ ì €ì¥ (í•„ìš”í•  ê²½ìš°)
                localStorage.setItem('modalOpened', 'true');
            }

            function closeReportModal() {
                const modal = document.getElementById('report-modal');
                modal.style.display = 'none';

                // ëª¨ë‹¬ ìƒíƒœ ì œê±°
                localStorage.removeItem('modalOpened');
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë‹¬ ìƒíƒœ í™•ì¸ ë° ì„¤ì •
            document.addEventListener('DOMContentLoaded', function () {
                const modal = document.getElementById('report-modal');
                const modalOpened = localStorage.getItem('modalOpened');

                if (modalOpened === 'true') {
                    modal.style.display = 'flex';
                } else {
                    modal.style.display = 'none';
                }
            });

            function submitReport() {
                const reviewId = document.getElementById('review-id').value;
                const reportReason = document.querySelector('input[name="report_reason"]:checked').value;

                fetch(`/reviews/review/${reviewId}/report/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reportReason }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        alert('ì‹ ê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeReportModal();

                        // ë¦¬ë·° DOM ìš”ì†Œ ìˆ¨ê¸°ê¸°
                        const reviewItem = document.querySelector(`[data-review-id="${reviewId}"]`);
                        if (reviewItem) {
                            reviewItem.style.display = 'none'; // DOMì—ì„œ ìˆ¨ê¹€
                        }
                    })
                    .catch((error) => console.error('Error:', error));
            }
        </script>

        <!-- TMDb ë¦¬ë·° ì„¹ì…˜ì„ ì‘ì„±ëœ ë¦¬ë·°ì™€ ìœ ì‚¬í•œ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • -->
        <h3 class="reviews-subtitle">TMDB ë¦¬ë·°</h3>

        <!-- TMDb ë¦¬ë·° ì •ë ¬ ì˜µì…˜ ì¶”ê°€ -->
        <form method="get" action="" class="sort-form">
            <label for="sort_tmdb" class="sort-label">ì •ë ¬ ê¸°ì¤€:</label>
            <select name="sort_tmdb" id="sort_tmdb" onchange="this.form.submit()">
                <option value="newest" {% if sort_option == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                <option value="highest_rating" {% if sort_option == 'highest_rating' %}selected{% endif %}>í‰ì  ë†’ì€ ìˆœ</option>
                <option value="lowest_rating" {% if sort_option == 'lowest_rating' %}selected{% endif %}>í‰ì  ë‚®ì€ ìˆœ</option>
            </select>
        </form>

        <ul class="reviews-list tmdb-review-list">
            {% if tmdb_reviews %}
            {% for review in tmdb_reviews %}
            <li class="review-item">
                <strong class="review-username">{{ review.author }}</strong> -
                <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span><br>
                <span class="review-rating">í‰ì : {{ review.author_details.rating }} / 10</span><br>
                <p class="review-content">{{ review.content }}</p>
                <a href="{{ review.url }}" target="_blank">ì›ë¬¸ ë³´ê¸°</a>
            </li>
            {% endfor %}
            {% else %}
            <p class="no-reviews-message">ì´ ì˜í™”ì— ëŒ€í•œ TMDB ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </ul>
    </section>
</body>
{% endblock %}
message.txt
22KB