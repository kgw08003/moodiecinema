{% extends 'moodiecinema/base.html' %}
{% load static %}
{% block content %}


{% block head %}
    <link rel="stylesheet" href="{% static 'movies.css' %}">
{% endblock %}

<body>
    <section class="movie-detail-container">
        <div class="movie-poster">
            <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}">
        </div>
        <div class="movie-info">
            <h1>{{ movie.title }}</h1>
            <p class="release-date"><strong>ê°œë´‰ì¼:</strong> {{ movie.release_date }}</p>
            <p class="genres"><strong>ì¥ë¥´:</strong> 
                {% for genre in movie.genres %}
                    {{ genre.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
            <p class="rating"><strong>í‰ì :</strong> {{ movie.vote_average }} / 10</p>
            <p class="overview">{{ movie.overview }}</p>
        </div>

        <!-- ì¶œì—°ì§„ ìŠ¬ë¼ì´ë” -->
    <section class="cast-list-container">
        <h2>ì¶œì—°ì§„</h2>
        <div class="cast-slider">
            <button class="scroll-button left" onclick="scrollCast('left')">&lt;</button>
            <div class="cast-list" id="cast-slider">
                {% for actor in cast %}
                    <div class="cast-item">
                        <a href="{% url 'actor_movies' actor.id %}">
                            <img src="{% if actor.profile_image_url %}{{ actor.profile_image_url }}{% else %}{% static 'images/no-image.png' %}{% endif %}" alt="{{ actor.name }}" width="50" height="75">
                            <span>{{ actor.name }}</span> <em>ì—­í• :</em> {{ actor.character }}
                        </a>
                    </div>
                {% endfor %}
            </div>
            <button class="scroll-button right" onclick="scrollCast('right')">&gt;</button>
        </div>
    </section>

    <!-- ì˜ˆê³ í¸ -->
    <section class="youtube-videos-container">
        <div class="additional-info">
            <h2>ì˜ˆê³ í¸</h2>
            {% if youtube_trailers %}
                {% for video in youtube_trailers %}
                    <iframe width="560" height="315" 
                            src="https://www.youtube.com/embed/{{ video.key }}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen 
                            onerror="handleVideoError(this)">
                    </iframe>
                {% endfor %}
            {% else %}
                <h3 style="color:white; margin:20px;">ì˜ˆê³ í¸ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
            {% endif %}
            <h3>ì˜ˆë§¤ ë§í¬</h3>
            <a href="#">ì˜ˆë§¤í•˜ê¸°</a>
        </div>
    </section>

    <!-- ìœ ì‚¬í•œ ì˜í™” ìŠ¬ë¼ì´ë” -->
    <section class="similar-movies-container">
        <h2>ìœ ì‚¬í•œ ì˜í™”</h2>
        <div class="slider-wrapper">
            <button class="scroll-button left" onclick="slideLeft()"><</button>
            <div class="horizontal-scroll">
                <div class="slider-container" id="similar-slider">
                    {% for similar_movie in similar_movies %}
                        <div class="slider-item">
                            <a href="{% url 'movie_detail' similar_movie.id %}">
                                <img src="https://image.tmdb.org/t/p/w300{{ similar_movie.poster_path }}" alt="{{ similar_movie.title }}">
                                <p>{{ similar_movie.title }}</p>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <button class="scroll-button right" onclick="slideRight()">></button>
        </div>
    </section>

    <script src="https://kit.fontawesome.com/23cecef777.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentIndex = 0;
        const itemWidth = 300; // ì•„ì´í…œì˜ ë„ˆë¹„ (ìŠ¬ë¼ì´ë“œ í•œ ë²ˆì— ì´ë™í•  ê±°ë¦¬)
        const slider = document.getElementById('similar-slider');
        const castList = document.getElementById('cast-slider');
        const items = slider.children;
        const castItems = castList.children;

        // ìœ ì‚¬ ì˜í™” ìŠ¬ë¼ì´ë” ì™¼ìª½ìœ¼ë¡œ ì´ë™
        function slideLeft() {
            if (currentIndex > 0) {
                currentIndex--;
                slider.style.transform = `translateX(-${currentIndex * itemWidth}px)`; // backtick ì‚¬ìš©
            }
        }
        
        // ìœ ì‚¬ ì˜í™” ìŠ¬ë¼ì´ë” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™
        function slideRight() {
            if (currentIndex < items.length - 3) {
                currentIndex++;
                slider.style.transform = `translateX(-${currentIndex * itemWidth}px)`; // backtick ì‚¬ìš©
            }
        }

        // ì¶œì—°ì§„ ìŠ¬ë¼ì´ë” ì™¼ìª½ìœ¼ë¡œ ì´ë™
        function scrollCast(direction) {
            const list = document.getElementById('cast-slider');
            const totalItems = castItems.length;
            if (direction === 'left') {
                list.scrollLeft -= itemWidth;
            } else if (direction === 'right') {
                list.scrollLeft += itemWidth;
            }
        }

        function handleVideoError(iframe) {
            // ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì˜ˆê³ í¸ì´ ì—†ë‹¤ëŠ” ë©”ì‹œì§€ë¥¼ í‘œì‹œ
            const trailerSection = iframe.closest('.additional-info');
            const noTrailerMessage = trailerSection.querySelector('h3');
            noTrailerMessage.textContent = 'ì˜ˆê³ í¸ì´ ì—†ìŠµë‹ˆë‹¤.';
            noTrailerMessage.style.color = 'white';
            noTrailerMessage.style.margin = '20px';
        }
    </script>
    <script>
        function likeReview(reviewId) {
            fetch(`/reviews/review/${reviewId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${reviewId}`).innerText = data.like_count;
            })
            .catch(error => console.error('Error:', error));
        }
        
        function dislikeReview(reviewId) {
            fetch(`/reviews/review/${reviewId}/dislike/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`dislike-count-${reviewId}`).innerText = data.dislike_count;
            })
            .catch(error => console.error('Error:', error));
        }
    </script>


    <!-- ë¦¬ë·° ì„¹ì…˜ ì¶”ê°€ -->
    <section class="reviews-section">
        <h2 class="reviews-title">ë¦¬ë·°</h2>
        <form method="post" action="{% url 'review_create' movie_id=movie_id %}" class="review-form">
            {% csrf_token %}
            {{ review_form.as_p }}
            <button type="submit" class="submit-button">ë¦¬ë·° ì‘ì„±</button>
        </form>
    
        <h3 class="reviews-subtitle">ì‘ì„±ëœ ë¦¬ë·°</h3>
        <ul class="reviews-list">
            {% for review in reviews %}
                <li class="review-item">
                    <strong class="review-username">{{ review.user.username }}</strong> - 
                    <span class="review-date">{{ review.created_at|date:"Y-m-d" }}</span><br>
                    <span class="review-rating">í‰ì : {{ review.rating }} / 5</span><br>
                    <p class="review-content">{{ review.content }}</p>
                    
                    <div class="like-dislike-buttons">
                        <button onclick="likeReview({{ review.id }})" class="like-button">
                            ğŸ‘ <span id="like-count-{{ review.id }}">{{ review.like_count }}</span>
                        </button>
                        <button onclick="dislikeReview({{ review.id }})" class="dislike-button">
                            ğŸ‘ <span id="dislike-count-{{ review.id }}">{{ review.dislike_count }}</span>
                        </button>
                    </div>
                
                </li>
            {% empty %}
                <p class="no-reviews-message">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            {% endfor %}
        </ul>
    
        <!-- TMDb ë¦¬ë·° ì„¹ì…˜ì„ ì‘ì„±ëœ ë¦¬ë·°ì™€ ìœ ì‚¬í•œ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • -->
        <h3 class="reviews-subtitle">TMDb ë¦¬ë·°</h3>
        <ul class="reviews-list tmdb-review-list">
            {% if tmdb_reviews %}
                {% for review in tmdb_reviews %}
                    <li class="review-item">
                        <strong class="review-username">{{ review.author }}</strong> - 
                        <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span><br>
                        <span class="review-rating">í‰ì : {{ review.author_details.rating }} / 10</span><br>
                        <p class="review-content">{{ review.content }}</p>
                        <a href="{{ review.url }}" target="_blank">ì›ë¬¸ ë³´ê¸°</a>
                    </li>
                {% endfor %}
            {% else %}
                <p class="no-reviews-message">ì´ ì˜í™”ì— ëŒ€í•œ TMDb ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </ul>
    </section>

</body>

{% endblock %}
