{% extends 'moodiecinema/base.html' %}
{% load static %}
{% block content %}


{% block head %}
    <link rel="stylesheet" href="{% static 'movies.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

<body>
    <section class="movie-detail-container">
        <div class="movie-poster">
            <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}">
        </div>
        <div class="movie-info">
            <h1>{{ movie.title }}</h1>
            <p class="release-date"><strong>ê°œë´‰ì¼:</strong> {{ movie.release_date }}</p>
            <p class="genres"><strong>ì¥ë¥´:</strong> 
                {% for genre in movie.genres %}
                    {{ genre.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
            <p class="rating"><strong>í‰ì :</strong> {{ movie.vote_average }} / 10</p>
            <p class="overview">{{ movie.overview }}</p>
        </div>

        <div class="additional-info">
            <h3>ì˜ˆê³ í¸ ë³´ê¸°</h3>
            {% if youtube_trailers %}
            {% for video in youtube_trailers %}
                <iframe width="560" height="315" src="https://www.youtube.com/embed/{{ video.key }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            {% endfor %}
            {% else %}
                <h3 style="color:white; margin:20px;">ì˜ˆê³ í¸ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
            {% endif %}
            <h3>ì˜ˆë§¤ ë§í¬</h3>
            <a href="#">ì˜ˆë§¤í•˜ê¸°</a>
        </div>

        <section class="cast-list">
            <h2>ì¶œì—°ì§„</h2>
            <ul>
                {% for actor in cast %}
                    <li><span>{{ actor.name }}</span> <em>ì—­í• :</em> {{ actor.character }}</li>
                {% endfor %}
            </ul>
        </section>

        <section class="similar-movies">
            <h2 style="margin:20px;">ìœ ì‚¬í•œ ì˜í™”</h2>
            <div class="similar-movie-grid">
                {% for similar_movie in similar_movies %}
                <div class="similar-movie-item">
                    <a href="{% url 'movie_detail' similar_movie.id %}">
                        <img src="https://image.tmdb.org/t/p/w300{{ similar_movie.poster_path }}" alt="{{ similar_movie.title }}">
                        <p>{{ similar_movie.title }}</p>
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>
    </section>
    </div>
    
    <section class="reviews-section">
        <h2 class="reviews-title">ë¦¬ë·°</h2>

        <!-- ë¦¬ë·° ì‘ì„± í¼ -->
        <form method="post" action="{% url 'review_create' movie_id=movie.id %}" class="review-form">
            {% csrf_token %}
            {{ review_form.as_p }}
            <button type="submit" class="submit-button">ë¦¬ë·° ì‘ì„±</button>
        </form>
        
        <!-- ì •ë ¬ ì˜µì…˜ê³¼ ë¦¬ë·° ëª©ë¡ -->
        <form method="get" action="" class="sort-form">
            <label for="sort" class="sort-label">ì •ë ¬ ê¸°ì¤€:</label>
            <select name="sort" id="sort" onchange="this.form.submit()">
                <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                <option value="highest_rating" {% if request.GET.sort == 'highest_rating' %}selected{% endif %}>í‰ì  ë†’ì€ ìˆœ</option>
                <option value="lowest_rating" {% if request.GET.sort == 'lowest_rating' %}selected{% endif %}>í‰ì  ë‚®ì€ ìˆœ</option>
                <option value="most_likes" {% if request.GET.sort == 'most_likes' %}selected{% endif %}>ì¢‹ì•„ìš” ë§ì€ ìˆœ</option>
            </select>
        </form>

        <ul class="reviews-list">
            {% for review in reviews %}
                <li class="review-item">
                    <strong class="review-username">{{ review.user.user_name }}</strong> - 
                    <span class="review-date">{{ review.created_at|date:"Y-m-d" }}</span><br>
                    <span class="review-rating">í‰ì : {{ review.rating }} / 5</span><br>
                    <p class="review-content">{{ review.content }}</p>
                    <!-- ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
                    <div class="emotion-analysis">
                        <h3>ê°ì • ë¶„ì„ ê²°ê³¼</h3>
                        <div class="emotion-box">
                            <p>{{ review.emotion|default:"ë¶„ì„ ê²°ê³¼ ì—†ìŒ" }}</p>
                        </div>
                    </div>
                    <div class="like-dislike-buttons">
                        <button onclick="likeReview({{ review.id }})" class="like-button">
                            ğŸ‘ <span id="like-count-{{ review.id }}">{{ review.like_count }}</span>
                        </button>
                        <button onclick="dislikeReview({{ review.id }})" class="dislike-button">
                            ğŸ‘ <span id="dislike-count-{{ review.id }}">{{ review.dislike_count }}</span>
                        </button>
                    </div>

                    <!-- ëª¨ë‹¬ ë²„íŠ¼ ë° ëª¨ë‹¬ ìš”ì†Œ -->
                    <button onclick="openReportModal({{ review.id }})" class="report-button">ğŸš¨ ì‹ ê³ </button>
                </li>
            {% empty %}
                <p class="no-reviews-message">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            {% endfor %}
        </ul>

        <!-- ì‹ ê³  ëª¨ë‹¬ ì°½ -->
        <div id="report-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeReportModal()">&times;</span>
                <h2>ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                
                <form id="report-form">
                    {% csrf_token %}
                    <input type="hidden" id="review-id" name="review_id">
                    
                    <label><input type="radio" name="report_reason" value="ìŠ¤íŒ¸" required> ìŠ¤íŒ¸</label><br>
                    <label><input type="radio" name="report_reason" value="ë¶€ì ì ˆí•œ ë‚´ìš©"> ë¶€ì ì ˆí•œ ë‚´ìš©</label><br>
                    <label><input type="radio" name="report_reason" value="ê±°ì§“ ì •ë³´"> ê±°ì§“ ì •ë³´</label><br>
                    
                    <button type="button" onclick="submitReport()">ì‹ ê³  ì œì¶œ</button>
                </form>
            </div>
        </div>

        <script>
            function getCsrfToken() {
                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            }

            function likeReview(reviewId) {
                fetch(`/reviews/review/${reviewId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),  // getCsrfToken() í•¨ìˆ˜ ì‚¬ìš©
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`like-count-${reviewId}`).innerText = data.like_count;
                })
                .catch(error => console.error('Error:', error));
            }
        
            function dislikeReview(reviewId) {
                fetch(`/reviews/review/${reviewId}/dislike/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),  // getCsrfToken() í•¨ìˆ˜ ì‚¬ìš©
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`dislike-count-${reviewId}`).innerText = data.dislike_count;
                })
                .catch(error => console.error('Error:', error));
            }

            function openReportModal(reviewId) {
                document.getElementById('report-modal').style.display = 'flex';
                document.getElementById('review-id').value = reviewId;

                // localStorageì— ëª¨ë‹¬ì´ ì—´ë ¸ë‹¤ëŠ” ìƒíƒœ ì €ì¥
                localStorage.setItem('modalOpened', 'true');
            }
            function closeReportModal() {
                document.getElementById('report-modal').style.display = 'none';

                // ëª¨ë‹¬ì´ ë‹«íˆë©´ ìƒíƒœ ì‚­ì œ
                localStorage.removeItem('modalOpened');
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë‹¬ ìë™ í‘œì‹œ ë°©ì§€
            document.addEventListener('DOMContentLoaded', function() {
                if (localStorage.getItem('modalOpened') !== 'true') {
                    closeReportModal();
                }
            });

            function submitReport() {
                const reviewId = document.getElementById('review-id').value;
                const reportReason = document.querySelector('input[name="report_reason"]:checked').value;

                fetch(`/reviews/review/${reviewId}/report/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),  // getCsrfToken() í•¨ìˆ˜ ì‚¬ìš©
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reportReason })
                })
                .then(response => response.json())
                .then(data => {
                    alert("ì‹ ê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeReportModal();
                    location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë³€ê²½ ë°˜ì˜
                })
                .catch(error => console.error("Error:", error));
            }
        </script>
    
        <!-- TMDb ë¦¬ë·° ì„¹ì…˜ì„ ì‘ì„±ëœ ë¦¬ë·°ì™€ ìœ ì‚¬í•œ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • -->
        <h3 class="reviews-subtitle">TMDB ë¦¬ë·°</h3>

        <!-- TMDb ë¦¬ë·° ì •ë ¬ ì˜µì…˜ ì¶”ê°€ -->
        <form method="get" action="" class="sort-form">
            <label for="sort_tmdb" class="sort-label">ì •ë ¬ ê¸°ì¤€:</label>
            <select name="sort_tmdb" id="sort_tmdb" onchange="this.form.submit()">
                <option value="newest" {% if request.GET.sort_tmdb == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                <option value="highest_rating" {% if request.GET.sort_tmdb == 'highest_rating' %}selected{% endif %}>í‰ì  ë†’ì€ ìˆœ</option>
                <option value="lowest_rating" {% if request.GET.sort_tmdb == 'lowest_rating' %}selected{% endif %}>í‰ì  ë‚®ì€ ìˆœ</option>
            </select>
        </form>

        <ul class="reviews-list tmdb-review-list">
            {% if tmdb_reviews %}
                {% for review in tmdb_reviews %}
                    <li class="review-item">
                        <strong class="review-username">{{ review.author }}</strong> - 
                        <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span><br>
                        <span class="review-rating">í‰ì : {{ review.author_details.rating }} / 10</span><br>
                        <p class="review-content">{{ review.content }}</p>
                        <a href="{{ review.url }}" target="_blank">ì›ë¬¸ ë³´ê¸°</a>
                    </li>
                {% endfor %}
            {% else %}
                <p class="no-reviews-message">ì´ ì˜í™”ì— ëŒ€í•œ TMDB ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </ul>
    </section>
</body>

{% endblock %}
